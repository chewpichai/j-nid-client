<?xml version="1.0" encoding="utf-8"?>
<mx:HBox xmlns:mx="http://www.adobe.com/2006/mxml"  xmlns:jn="com.j_nid.validators.*"
	width="100%" height="100%" creationComplete="init(event)">
	
	<mx:Script>
		<![CDATA[
			import com.j_nid.controls.EventNames;
			import com.j_nid.utils.CairngormUtils;
			import com.adobe.cairngorm.control.CairngormEventDispatcher;
			import com.j_nid.models.JNidModelLocator;
			import mx.rpc.events.ResultEvent;
			import mx.collections.SortField;
			import mx.collections.Sort;
			import mx.events.ValidationResultEvent;
			import mx.events.IndexChangedEvent;
			import mx.containers.ViewStack;
			import mx.controls.Alert;
			import com.j_nid.models.BankAccount;
			import com.j_nid.models.PhoneNumber;
			import com.j_nid.models.Person;
			import mx.collections.ArrayCollection;
			import mx.events.ListEvent;
			import mx.events.FlexEvent;
			import mx.utils.StringUtil;
			
			[Bindable]
			public var person:Person;
			[Bindable]
			private var phoneTypes:XMLList;
			[Bindable]
			private var banks:XMLList;
			private var isEdit:Boolean = false;
			private var personSelectedIndex:int = -1;
			private var errorMessage:String;
			[Bindable]
			public var model:JNidModelLocator = JNidModelLocator.getInstance();
			
			private function init(e:FlexEvent):void {
				person = new Person();
			}
						
			private function phoneTypeResultListener(e:ResultEvent):void {
				phoneTypes = e.result.phone_type;
			}
			
			private function bankResultListener(e:ResultEvent):void {
				banks = e.result.bank;
			}
			
			private function searchFieldChangeListener(e:Event):void {
				personList.dataProvider.filterFunction = function(item:Object):Boolean {
					var person:Person = Person(item);
					person.sortIndex = person.name.indexOf(searchField.text);
					return person.sortIndex != -1;
				};
				var sort:Sort = new Sort();
				sort.fields = [new SortField("sortIndex")];
				personList.dataProvider.sort = sort;
				personList.dataProvider.refresh();
			}
			
			private function personListChangeListener(e:ListEvent):void {
				person = Person(personList.selectedItem);
				isEdit = true;
			}
			
			private function newClickListener(e:MouseEvent):void {
				person = new Person();
				personList.selectedIndex = -1;
				isEdit = false;
			}
			
			private function clearClickListener(e:MouseEvent):void {
				
			}
			
			private function saveClickListener(e:MouseEvent):void {
				if (isValid()) {
					person.name = nameField.text;
					person.firstName = firstNameField.text;
					person.lastName = lastNameField.text;
					person.idCardNumber = idCardNumberFiled.text;
					person.address = addressField.text;
					person.detail1 = detail1Field.text;
					person.detail2 = detail2Field.text;
					if (isEdit) {
						CairngormUtils.dispatchEvent(EventNames.UPDATE_PERSON, person);
					} else {
						model.personToCreate = person;
						CairngormUtils.dispatchEvent(EventNames.CREATE_PERSON, person);
					}
				} else {
					Alert.show(errorMessage, "Error");
				}
			}
			
			private function isValid():Boolean {
				errorMessage = "";
				var validationResult:ValidationResultEvent = nameValidator.validate();
				if (validationResult.type == ValidationResultEvent.INVALID) {
					errorMessage += "Check name.\n";
				}
				return errorMessage.length == 0;
			}
			
			public function getPhoneTypeIndex(type:String):int {
				for (var i:int = 0; i < model.phoneTypes.length(); i++) {
					if (model.phoneTypes[i].data == type) {
						return i;
					}
				}
				return -1;
			}
			
			public function getBankNameIndex(bank:String):int {
				for (var i:int = 0; i < model.bankNames.length(); i++) {
					if (model.bankNames[i].data == bank) {
						return i;
					}
				}
				return -1;
			}
		]]>
	</mx:Script>
	
	<mx:Panel width="280" height="100%" layout="vertical" title="Person List" 
		paddingTop="10" borderStyle="solid">
		<mx:FormItem label="Search" width="100%">
			<mx:TextInput id="searchField" width="100%" 
				change="searchFieldChangeListener(event)"/>
		</mx:FormItem>
		<mx:List id="personList" dataProvider="{model.people}" 
			width="100%" height="100%" borderStyle="solid"
			labelField="name" change="personListChangeListener(event)" 
			borderThickness="2" cornerRadius="4" borderColor="#74981C"/>
		<mx:ControlBar horizontalAlign="right">
			<mx:Button id="newBtn" label="New" click="newClickListener(event)"/>
		</mx:ControlBar>
	</mx:Panel>
	
	<mx:Panel layout="absolute" title="Person Form" horizontalAlign="center" 
		height="100%" width="100%">
		<mx:Accordion creationPolicy="all" width="100%" height="100%" x="0" y="0">
			<mx:Form width="100%" height="100%" label="Name">
				<mx:FormItem label="Name" required="true">
					<mx:TextInput id="nameField" text="{person.name}"/>
				</mx:FormItem>
				<mx:FormItem label="First Name">
					<mx:TextInput id="firstNameField" text="{person.firstName}"/>
				</mx:FormItem>
				<mx:FormItem label="Last Name">
					<mx:TextInput id="lastNameField" text="{person.lastName}"/>
				</mx:FormItem>
				<mx:FormItem label="ID Card No">
					<mx:TextInput id="idCardNumberFiled" text="{person.idCardNumber}"/>
				</mx:FormItem>
			</mx:Form>
			
			<mx:Form label="Address" width="100%" height="100%">
				<mx:FormItem label="Address">
					<mx:TextArea id="addressField" text="{person.address}" 
						height="80" width="200"/>
				</mx:FormItem>
				<mx:FormItem label="Detail">
					<mx:TextArea id="detail1Field" text="{person.detail1}" 
						height="80" width="200"/>
				</mx:FormItem>
				<mx:FormItem label="Detail" horizontalAlign="left">
					<mx:TextArea id="detail2Field" text="{person.detail2}" 
						height="80" width="200"/>
				</mx:FormItem>
			</mx:Form>
			
			<mx:VBox label="Phone Number List" width="100%" height="100%">
				<mx:DataGrid id="phoneNumberList" dataProvider="{person.phoneNumbers}" 
					width="100%" resizableColumns="false">
					<mx:columns>
						<mx:DataGridColumn dataField="number" headerText="Number"/>
						<mx:DataGridColumn dataField="type" headerText="Type" width="220">
							<mx:itemRenderer>
								<mx:Component>
<mx:ComboBox dataProvider="{outerDocument.model.phoneTypes}" cornerRadius="0"
	selectedIndex="{outerDocument.getPhoneTypeIndex(data.type)}"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
					</mx:columns>
				</mx:DataGrid>
				<mx:Spacer height="100%"/>
				<mx:HBox width="100%" paddingTop="5" paddingBottom="5" paddingLeft="5" 
					paddingRight="5">
					<mx:Label text="Number:"/>
					<mx:TextInput width="100%"/>
					<mx:ComboBox dataProvider="{model.phoneTypes}" width="220"/>
					<mx:Button label="Add"/>
				</mx:HBox>
			</mx:VBox>
			
			<mx:VBox label="Bank Account List" width="100%" height="100%">
				<mx:DataGrid id="bankAccountList" dataProvider="{person.bankAccounts}" 
					width="100%" resizableColumns="false">
					<mx:columns>
						<mx:DataGridColumn dataField="number" headerText="Number"/>
						<mx:DataGridColumn dataField="bank" headerText="Bank" width="50">
							<mx:itemRenderer>
								<mx:Component>
<mx:ComboBox dataProvider="{outerDocument.model.bankNames}" 
	selectedIndex="{outerDocument.getBankNameIndex(data.bank)}"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
					</mx:columns>
				</mx:DataGrid>
				<mx:Spacer height="100%"/>
				<mx:HBox width="100%" paddingTop="5" paddingBottom="5" paddingLeft="5" 
					paddingRight="5">
					<mx:Label text="Number:"/>
					<mx:TextInput width="100%"/>
					<mx:ComboBox dataProvider="{model.bankNames}" width="220"/>
					<mx:Button label="Add"/>
				</mx:HBox>
			</mx:VBox>
		</mx:Accordion>
		
		<mx:ControlBar horizontalAlign="right" x="0" y="517">
			<mx:Button label="Clear" id="clearBtn"/>
			<mx:Button label="Save" id="saveBtn" click="saveClickListener(event)"/>
		</mx:ControlBar>
	</mx:Panel>	
	
	<mx:StringValidator id="nameValidator" source="{nameField}" property="text"
		trigger="{saveBtn}" triggerEvent="click"/>
</mx:HBox>
